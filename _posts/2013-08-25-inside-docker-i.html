<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC
    "-//W3C//DTD XHTML 1.1 plus MathML 2.0 plus SVG 1.1//EN"
    "http://www.w3.org/2002/04/xhtml-math-svg/xhtml-math-svg.dtd">
<html xml:lang='en' xmlns:svg='http://www.w3.org/2000/svg' xmlns='http://www.w3.org/1999/xhtml'>
<head><meta content='application/xhtml+xml;charset=utf-8' http-equiv='Content-type' /><title></title></head>
<body><hr />
<p>layout: post title: &#8220;Inside docker I&#8221; description: &#8220;Setup and API exploration&#8221; category:</p>

<h2 id='tags_docker'>tags: docker</h2>

<p>{% include JB/setup %}</p>

<h2 id='overview'>Overview</h2>

<p>This is an atypical introduction to docker. It aims to learn more about the internals of lxc and aufs by experimenting and analyzing what docker is doing behind the scenes. The inspiration for this post comes from my favourite article from sysadvent - <a href='http://sysadvent.blogspot.com/2010/12/day-15-down-ls-rabbit-hole.html'>Down the ls Rabbit Hole</a>. It reflects how I like to try to get understanding of various systems from a black box/trace approach before diving into the code.</p>

<p>Docker has had a lot of attention, and I wanted to get a deeper understanding of how it works. I&#8217;m starting with pretty minimal knowledge on how docker works, I&#8217;ve done the introduction tutorial and attended a Meetup where I saw a 101. I know it uses lxc and aufs under the hood but I&#8217;ve not done much with those at all. I wanted to see if we can understand what&#8217;s going on using standard Linux system tools.</p>

<h2 id='requirements'>Requirements</h2>

<p>Pre-requisites - install virtualbox and vagrant as per the docker installatino</p>

<ul>
<li>http://docs.docker.io/en/latest/installation/vagrant/</li>
</ul>

<p>Create a clone of the main docker repo, we won&#8217;t use it right away but in a later post I intend to examine the source some more.</p>

<p><code>
git clone https://github.com/dotcloud/docker.git
cd docker
vagrant up
</code></p>

<p>If you&#8217;ve not used docker before take some time to run the <a href='http://docs.docker.io/en/latest/examples/hello_world/#hello-world'>hello world example</a>. I&#8217;m currently assuming you&#8217;re running as root on the vagrant image (eg <code>sudo -s</code>).</p>

<p><code>
docker run ubuntu /bin/echo hello world
hello world
</code></p>

<h2 id='going_deeper'>Going deeper</h2>

<p>Lets take a closer look at the Hello World example by using our old friend <code>strace</code>.</p>

<p><code>
strace -e trace=file,network,write -s2048  -tt -fF -o /tmp/docker.out docker run ubuntu /bin/echo hello world
</code></p>

<p>This is what I get:</p>

<p><code>
1782  10:45:58.022405 execve(&quot;/usr/bin/docker&quot;, [&quot;docker&quot;, &quot;run&quot;, &quot;ubuntu&quot;, &quot;/bin/echo&quot;, &quot;hello&quot;, &quot;world&quot;], [/* 20 vars */]) = 0
1782  10:45:58.135032 open(&quot;/proc/sys/net/core/somaxconn&quot;, O_RDONLY|O_CLOEXEC) = 3
1782  10:45:58.135549 read(3, &quot;128\n&quot;, 4096) = 4
1782  10:45:58.136000 read(3, &quot;&quot;, 4092) = 0
1782  10:45:58.136823 socket(PF_INET6, SOCK_STREAM, IPPROTO_TCP) = 3
1782  10:45:58.137154 setsockopt(3, SOL_IPV6, IPV6_V6ONLY, [0], 4) = 0
1782  10:45:58.137356 bind(3, {sa_family=AF_INET6, sin6_port=htons(0), inet_pton(AF_INET6, &quot;::1&quot;, &amp;sin6_addr), sin6_flowinfo=0, sin6_scope_id=0}, 28) = 0
1782  10:45:58.138761 socket(PF_INET6, SOCK_STREAM, IPPROTO_TCP) = 4
1782  10:45:58.139251 setsockopt(4, SOL_IPV6, IPV6_V6ONLY, [0], 4) = 0
1782  10:45:58.139782 bind(4, {sa_family=AF_INET6, sin6_port=htons(0), inet_pton(AF_INET6, &quot;::ffff:127.0.0.1&quot;, &amp;sin6_addr), sin6_flowinfo=0, sin6_scope_id=0}, 28) = 0
1782  10:45:58.272733 stat(&quot;/usr/local/sbin/docker&quot;, 0xc2000d8000) = -1 ENOENT (No such file or directory)
1782  10:45:58.273302 stat(&quot;/usr/local/bin/docker&quot;, 0xc2000d8090) = -1 ENOENT (No such file or directory)
1782  10:45:58.274013 stat(&quot;/usr/sbin/docker&quot;, 0xc2000d8120) = -1 ENOENT (No such file or directory)
1782  10:45:58.274566 stat(&quot;/usr/bin/docker&quot;, {st_mode=S_IFREG|0755, st_size=5770760, ...}) = 0
1782  10:45:58.275128 stat(&quot;/usr/local/sbin/docker&quot;, 0xc2000d8240) = -1 ENOENT (No such file or directory)
1782  10:45:58.275643 stat(&quot;/usr/local/bin/docker&quot;, 0xc2000d82d0) = -1 ENOENT (No such file or directory)
1782  10:45:58.276159 stat(&quot;/usr/sbin/docker&quot;, 0xc2000d8360) = -1 ENOENT (No such file or directory)
1782  10:45:58.276577 stat(&quot;/usr/bin/docker&quot;, {st_mode=S_IFREG|0755, st_size=5770760, ...}) = 0
1782  10:45:58.278058 stat(&quot;/home/vagrant/.dockercfg&quot;, 0xc2000d8480) = -1 ENOENT (No such file or directory)
1782  10:45:58.279033 socket(PF_FILE, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3
1782  10:45:58.279570 setsockopt(3, SOL_SOCKET, SO_BROADCAST, [1], 4) = 0
1782  10:45:58.281848 connect(3, {sa_family=AF_FILE, path=&quot;/var/run/docker.sock&quot;}, 23) = 0
1782  10:45:58.282319 getsockname(3, {sa_family=AF_FILE, NULL}, [2]) = 0
1782  10:45:58.282688 getpeername(3, {sa_family=AF_FILE, path=&quot;/var/run/docker.sock&quot;}, [23]) = 0
1782  10:45:58.283017 write(3, &quot;POST /v1.4/containers/create HTTP/1.1\r\nHost: \r\nUser-Agent: Docker-Client/0.5.3\r\nContent-Length: 335\r\nContent-Type: application/json\r\n\r\n{\&quot;Hostname\&quot;:\&quot;\&quot;,\&quot;User\&quot;:\&quot;\&quot;,\&quot;Memory\&quot;:0,\&quot;MemorySwap\&quot;:0,\&quot;CpuShares\&quot;:0,\&quot;AttachStdin\&quot;:false,\&quot;AttachStdout\&quot;:true,\&quot;AttachStderr\&quot;:true,\&quot;PortSpecs\&quot;:null,\&quot;Tty\&quot;:false,\&quot;OpenStdin\&quot;:false,\&quot;StdinOnce\&quot;:false,\&quot;Env\&quot;:null,\&quot;Cmd\&quot;:[\&quot;/bin/echo\&quot;,\&quot;hello\&quot;,\&quot;world\&quot;],\&quot;Dns\&quot;:null,\&quot;Image\&quot;:\&quot;ubuntu\&quot;,\&quot;Volumes\&quot;:{},\&quot;VolumesFrom\&quot;:\&quot;\&quot;,\&quot;Entrypoint\&quot;:[],\&quot;NetworkDisabled\&quot;:false}&quot;, 470) = 470
1782  10:45:58.284722 read(3, &quot;HTTP/1.1 201 Created\r\nContent-Type: text/plain; charset=utf-8\r\nContent-Length: 21\r\nDate: Sun, 25 Aug 2013 10:45:58 GMT\r\n\r\n{\&quot;Id\&quot;:\&quot;6b4b8793687d\&quot;}&quot;, 4096) = 143
1782  10:45:58.286191 socket(PF_FILE, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3
1782  10:45:58.286529 setsockopt(3, SOL_SOCKET, SO_BROADCAST, [1], 4) = 0
1782  10:45:58.287292 connect(3, {sa_family=AF_FILE, path=&quot;/var/run/docker.sock&quot;}, 23) = 0
1782  10:45:58.287629 getsockname(3, {sa_family=AF_FILE, NULL}, [2]) = 0
1782  10:45:58.287989 getpeername(3, {sa_family=AF_FILE, path=&quot;/var/run/docker.sock&quot;}, [23]) = 0
1782  10:45:58.288605 write(3, &quot;POST /v1.4/containers/6b4b8793687d/start HTTP/1.1\r\nHost: \r\nUser-Agent: Docker-Client/0.5.3\r\nContent-Length: 35\r\nContent-Type: application/json\r\n\r\n{\&quot;Binds\&quot;:null,\&quot;ContainerIDFile\&quot;:\&quot;\&quot;}&quot;, 181) = 181
1782  10:45:58.290946 read(3, 0xc200132000, 4096) = -1 EAGAIN (Resource temporarily unavailable)
1782  10:45:58.293395 read(3, &quot;HTTP/1.1 204 No Content\r\nContent-Type: text/plain; charset=utf-8\r\nContent-Length: 0\r\nDate: Sun, 25 Aug 2013 10:45:58 GMT\r\n\r\n&quot;, 4096) = 124
1782  10:45:58.294246 socket(PF_FILE, SOCK_STREAM|SOCK_CLOEXEC|SOCK_NONBLOCK, 0) = 3
1782  10:45:58.294400 setsockopt(3, SOL_SOCKET, SO_BROADCAST, [1], 4) = 0
1782  10:45:58.295089 connect(3, {sa_family=AF_FILE, path=&quot;/var/run/docker.sock&quot;}, 23) = 0
1782  10:45:58.295432 getsockname(3, {sa_family=AF_FILE, NULL}, [2]) = 0
1782  10:45:58.295774 getpeername(3, {sa_family=AF_FILE, path=&quot;/var/run/docker.sock&quot;}, [23]) = 0
1782  10:45:58.296514 write(3, &quot;POST /v1.4/containers/6b4b8793687d/attach?logs=1&amp;stderr=1&amp;stdout=1&amp;stream=1 HTTP/1.1\r\nHost: \r\nUser-Agent: Docker-Client/0.5.3\r\nContent-Length: 0\r\nContent-Type: plain/text\r\n\r\n&quot;, 174) = 174
1782  10:45:58.297613 read(3, 0xc200135000, 4096) = -1 EAGAIN (Resource temporarily unavailable)
1782  10:45:58.298491 read(3, &quot;HTTP/1.1 200 OK\r\nContent-Type: application/vnd.docker.raw-stream\r\n\r\n&quot;, 4096) = 68
1782  10:45:58.298962 write(1, &quot;&quot;, 0)   = 0
1782  10:45:58.299223 read(3, 0xc200135000, 4096) = -1 EAGAIN (Resource temporarily unavailable)
1782  10:45:58.301381 read(0,  &lt;unfinished ...&gt;
1786  10:45:58.463570 read(3, &quot;hello world\n&quot;, 4096) = 12
1786  10:45:58.464443 write(1, &quot;hello world\n&quot;, 12) = 12
1786  10:45:58.465872 read(3, 0xc200135000, 4096) = -1 EAGAIN (Resource temporarily unavailable)
1788  10:45:58.475465 read(3, &quot;&quot;, 4096) = 0
</code></p>

<p>As we can see we have a REST API over a unix socket. The REST API is lnked to from the <a href='http://docs.docker.io/en/latest/'>docs home page</a>.</p>

<p>The API is fully documented, from the strace output we can see that we&#8217;re using <a href='http://docs.docker.io/en/latest/api/docker_remote_api_v1.4/'>1.4</a></p>

<p>Sadly this means we can&#8217;t use curl in the default configuration. You can enable an HTTP connection via a command line flag.</p>

<p>In our git repository lets see if we can figure out what is going on</p>

<p><code>
 git grep /usr/bin/docker
 hack/release/make.sh:    /usr/bin/docker -d
 hack/release/make.sh:   cp bundles/$VERSION/binary/docker-$VERSION $DIR/usr/bin/docker
 packaging/ubuntu/docker.upstart:    /usr/bin/docker -d
 packaging/ubuntu/lxc-docker.prerm:if [ &quot;`pgrep -f &#39;/usr/bin/docker -d&#39;`&quot; != &quot;&quot; ]; then /sbin/stop docker; fi
</code></p>

<p>Reading the sources we can run a port so lets edit <code>/etc/init/docker.conf</code> and change the script to</p>

<p><code>
    /usr/bin/docker -d -H 127.0.0.1:4243
</code></p>
</body></html>
